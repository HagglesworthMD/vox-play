name: VoxelMask Test Suite

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y dcm2niix
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
        pip install pydicom numpy
        pip install dicom2nifti nibabel scipy
        pip install streamlit
        # Install remaining requirements (may have optional deps)
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt || true
        fi
    
    - name: Verify installations
      run: |
        python -c "import pytest; print(f'pytest {pytest.__version__}')"
        python -c "import pydicom; print(f'pydicom {pydicom.__version__}')"
        dcm2niix -v || echo "dcm2niix version check"
    
    - name: Run tests
      run: |
        pytest -v --tb=short
      env:
        PYTHONPATH: ${{ github.workspace }}/src
    
    - name: Run tests with coverage
      run: |
        pytest --cov=src --cov-report=xml --cov-report=term-missing
      env:
        PYTHONPATH: ${{ github.workspace }}/src
      continue-on-error: true
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
      continue-on-error: true

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8
    
    - name: Lint with flake8
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 src/ --count --exit-zero --max-complexity=15 --max-line-length=120 --statistics
      continue-on-error: true

  build-windows-exe:
    name: Build Windows Executable
    runs-on: windows-latest
    needs: test  # Only build if tests pass
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install streamlit
        pip install pydicom numpy
        pip install opencv-python-headless
        pip install Pillow
        pip install fpdf2>=2.7.0
        pip install dicom2nifti>=2.4.9
        pip install nibabel>=5.1.0
        pip install scipy>=1.10.0
        pip install streamlit-drawable-canvas==0.9.3
        # Install remaining requirements (skip PaddleOCR on Windows build for now)
        pip install -r requirements_no_paddle.txt || true
    
    - name: Build Windows executable
      run: |
        pyinstaller --onefile `
          --additional-hooks-dir=./hooks `
          --add-data "src;src" `
          --add-data ".streamlit;.streamlit" `
          --hidden-import=streamlit `
          --hidden-import=streamlit.runtime.scriptrunner.magic_funcs `
          --hidden-import=pydicom `
          --hidden-import=numpy `
          --hidden-import=PIL `
          --hidden-import=cv2 `
          --hidden-import=fpdf2 `
          --hidden-import=dicom2nifti `
          --hidden-import=nibabel `
          --hidden-import=scipy `
          --collect-all=streamlit `
          --collect-all=streamlit_drawable_canvas `
          --clean `
          --name VoxelMask `
          src/run_wrapper.py
      shell: pwsh
    
    - name: Verify build
      run: |
        if (Test-Path "dist/VoxelMask.exe") {
          Write-Host "✅ VoxelMask.exe built successfully!"
          Get-Item "dist/VoxelMask.exe" | Select-Object Name, Length, LastWriteTime
        } else {
          Write-Host "❌ Build failed - VoxelMask.exe not found"
          exit 1
        }
      shell: pwsh
    
    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: VoxelMask-Windows-Executable
        path: dist/VoxelMask.exe
        retention-days: 30
        if-no-files-found: error
